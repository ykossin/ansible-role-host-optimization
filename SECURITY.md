# Безопасность роли host-optimization

## Критические изменения системы

Роль `host-optimization` вносит **критические изменения** в систему, которые могут повлиять на стабильность и доступность сервера. Всегда используйте защитные механизмы перед применением!

## Защитные механизмы

### 1. Check Mode (Dry-Run)

**ВСЕГДА используйте check mode перед применением!**

```bash
# Проверка всех изменений без применения
ansible-playbook playbook.yml --check

# С детальным выводом изменений
ansible-playbook playbook.yml --check --diff

# Проверка только определенных тегов
ansible-playbook playbook.yml --check --tags memory,network
```

**Что покажет check mode:**
- Какие файлы будут изменены
- Какие параметры будут настроены
- Какие предупреждения безопасности сработают
- Не применит реальные изменения

**Задачи с поддержкой check mode:**
- Все задачи роли поддерживают check mode
- Критические операции (swap, fstab, grub) требуют подтверждения даже в check mode

### 2. Проверки безопасности

Роль автоматически выполняет проверки перед критическими изменениями:

#### Проверка перед отключением swap:
- Проверка доступной памяти (минимум 16GB)
- Проверка использования swap (не более 10%)
- Критические предупреждения при несоответствии
- Требование подтверждения через переменную

#### Проверка перед изменением GRUB:
- Отображение текущих параметров ядра
- Предупреждение о необходимости перезагрузки
- Рекомендация проверки доступа к консоли

#### Проверка перед изменением fstab:
- Проверка текущего состояния noatime
- Предупреждение о критичности изменений
- Автоматическое резервное копирование

#### Валидация параметров памяти:
- Проверка диапазонов значений
- Проверка логической корректности (dirty_background_ratio < dirty_ratio)
- Критические ошибки при некорректных значениях

### 3. Подтверждение опасных операций

Для критических операций требуется явное подтверждение:

```yaml
# В playbook или переменных
host_optimization_confirm_dangerous: true
```

**Операции, требующие подтверждения:**
- Отключение swap (`host_swap_disabled: true`)
- Изменение fstab (`host_fstab_noatime: true`)
- Изменение GRUB (параметры ядра)

**Без подтверждения:**
- Роль выдаст предупреждения и остановится
- Критические операции не будут выполнены
- Безопасные операции (sysctl, limits) выполнятся

### 4. Автоматическое резервное копирование

Роль автоматически создает резервные копии перед изменением:

**Расположение бэкапов:**
```
/root/ansible-backups/host-optimization/
├── grub-<timestamp>.bak
├── fstab-<timestamp>.bak
└── limits-<timestamp>.bak
```

**Что бэкапится:**
- `/etc/default/grub` - перед изменением параметров ядра
- `/etc/fstab` - перед добавлением noatime
- `/etc/security/limits.conf` - перед изменением лимитов

**Восстановление из бэкапа:**
```bash
# Восстановление GRUB
cp /root/ansible-backups/host-optimization/grub-<timestamp>.bak /etc/default/grub
update-grub

# Восстановление fstab
cp /root/ansible-backups/host-optimization/fstab-<timestamp>.bak /etc/fstab
mount -a

# Восстановление limits.conf
cp /root/ansible-backups/host-optimization/limits-<timestamp>.bak /etc/security/limits.conf
```

## Критические операции и риски

### 1. Отключение swap

**Риски:**
- Нехватка памяти при пиковых нагрузках
- Завершение процессов OOM killer
- Нестабильность системы

**Защита:**
- Проверка доступной памяти (минимум 16GB)
- Проверка использования swap (не более 10%)
- Требование подтверждения

**Рекомендации:**
- Используйте только на серверах с достаточным RAM (32GB+)
- Мониторьте использование памяти после отключения
- Рассмотрите уменьшение swappiness вместо полного отключения

### 2. Изменение fstab

**Риски:**
- Невозможность загрузки системы при ошибке
- Проблемы с монтированием файловых систем
- Потеря доступа к системе

**Защита:**
- Автоматическое резервное копирование
- Проверка текущего состояния
- Предупреждения перед изменением

**Рекомендации:**
- Всегда имейте доступ к консоли сервера
- Проверьте синтаксис fstab после изменений: `mount -a`
- Сохраните бэкап в безопасном месте

### 3. Изменение параметров ядра (GRUB)

**Риски:**
- Невозможность загрузки системы
- Проблемы с драйверами
- Потеря доступа к системе

**Защита:**
- Автоматическое резервное копирование
- Предупреждение о необходимости перезагрузки
- Проверка параметров перед добавлением

**Рекомендации:**
- Всегда имейте доступ к консоли сервера
- Проверьте параметры после перезагрузки: `cat /proc/cmdline`
- Тестируйте на тестовом сервере перед продакшеном

### 4. Изменение параметров памяти

**Риски:**
- Нестабильность системы
- Проблемы с производительностью
- OOM killer завершает процессы

**Защита:**
- Валидация всех параметров
- Проверка логической корректности
- Предупреждения при некорректных значениях

**Рекомендации:**
- Используйте проверенные значения
- Мониторьте систему после изменений
- Тестируйте на тестовом сервере

## Рекомендуемый процесс применения

### Шаг 1: Подготовка

1. Убедитесь, что у вас есть доступ к консоли сервера
2. Создайте полную резервную копию системы
3. Протестируйте на тестовом сервере
4. Изучите документацию роли

### Шаг 2: Проверка (Check Mode)

```bash
# Проверка всех изменений
ansible-playbook playbook.yml --check --diff

# Проверка только безопасных операций
ansible-playbook playbook.yml --check --skip-tags kernel,filesystem,swap

# Проверка критических операций
ansible-playbook playbook.yml --check --tags kernel,filesystem,swap
```

### Шаг 3: Применение безопасных операций

```bash
# Применение только безопасных операций
ansible-playbook playbook.yml --skip-tags kernel,filesystem,swap
```

**Безопасные операции:**
- Настройка sysctl (память, сеть)
- Настройка CPU governor
- Настройка лимитов
- Настройка tuned

### Шаг 4: Применение критических операций

```bash
# С подтверждением опасных операций
ansible-playbook playbook.yml \
  -e "host_optimization_confirm_dangerous=true" \
  --tags kernel,filesystem,swap
```

**Критические операции:**
- Изменение GRUB (требует перезагрузки)
- Изменение fstab
- Отключение swap

### Шаг 5: Проверка и перезагрузка

```bash
# Проверка применённых настроек
ansible-playbook playbook.yml --tags verify

# Перезагрузка (если изменялись параметры ядра)
sudo reboot
```

## Восстановление после проблем

### Проблема: Система не загружается

1. Загрузитесь с консоли или rescue режима
2. Восстановите GRUB из бэкапа:
   ```bash
   cp /root/ansible-backups/host-optimization/grub-*.bak /etc/default/grub
   update-grub
   ```
3. Перезагрузите систему

### Проблема: Ошибки монтирования

1. Загрузитесь с консоли или rescue режима
2. Восстановите fstab из бэкапа:
   ```bash
   cp /root/ansible-backups/host-optimization/fstab-*.bak /etc/fstab
   mount -a
   ```
3. Проверьте синтаксис: `mount -a`

### Проблема: Нехватка памяти

1. Если swap отключен, включите обратно:
   ```bash
   # Раскомментируйте swap в fstab
   sed -i 's/^#\(.*swap.*\)/\1/' /etc/fstab
   swapon -a
   ```
2. Или увеличьте RAM
3. Или уменьшите swappiness вместо отключения swap

## Мониторинг после применения

### Проверка параметров памяти

```bash
# Swappiness
sysctl vm.swappiness

# Dirty pages
sysctl vm.dirty_ratio vm.dirty_background_ratio

# Overcommit
sysctl vm.overcommit_memory
```

### Проверка сети

```bash
# IP forwarding
sysctl net.ipv4.ip_forward

# TCP параметры
sysctl net.ipv4.tcp_rmem net.ipv4.tcp_wmem
```

### Проверка CPU

```bash
# CPU governor
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# CPU frequency
cat /proc/cpuinfo | grep MHz
```

### Проверка файловых систем

```bash
# Монтирование
mount | grep noatime

# I/O scheduler
cat /sys/block/*/queue/scheduler
```

### Проверка swap

```bash
# Статус swap
swapon --show
free -h

# Использование памяти
free -h
vmstat 1 5
```

## Контакты и поддержка

При возникновении проблем:
1. Проверьте логи Ansible
2. Проверьте бэкапы в `/root/ansible-backups/host-optimization/`
3. Восстановите из бэкапов при необходимости
4. Обратитесь к документации роли

---

**Помните:** Всегда используйте check mode перед применением критических изменений!
