---
# ============================================================================
# Оптимизация параметров памяти
# ============================================================================
# Этот файл настраивает параметры управления памятью системы для виртуализации.
# Включает настройку swappiness, dirty pages, overcommit, hugepages и swap.
#
# Критические операции:
# - Отключение swap требует подтверждения (host_optimization_confirm_dangerous)
# - Изменение параметров памяти может повлиять на производительность
#
# Риски:
# - Слишком низкий swappiness может привести к нехватке памяти
# - Слишком высокий swappiness может снизить производительность
# - Отключение swap может привести к завершению процессов OOM killer
# ============================================================================

- name: Оптимизация swappiness
  # Настраивает vm.swappiness - определяет, насколько агрессивно система
  # будет использовать swap вместо физической памяти.
  #
  # Значения:
  # - 0: система будет избегать использования swap (может привести к нехватке памяти)
  # - 10: рекомендуемое значение для серверов с большим RAM
  # - 60: значение по умолчанию в большинстве дистрибутивов
  # - 100: система будет активно использовать swap (снижает производительность)
  #
  # Риски:
  # - Слишком низкое значение (0-1) может привести к нехватке памяти при пиковых нагрузках
  # - Слишком высокое значение может привести к медленной работе из-за частого использования swap
  #
  # Применяется: Сразу, не требует перезагрузки
  # Файл: /proc/sys/vm/swappiness
  sysctl:
    name: vm.swappiness
    value: "{{ host_swappiness }}"
    state: present
    sysctl_set: true  # Сохраняет в /etc/sysctl.conf для постоянства
    reload: true      # Применяет сразу
  when: host_optimization_enabled
  tags:
    - optimization
    - memory

- name: Настройка параметров памяти для виртуализации
  # Настраивает параметры "грязных" страниц памяти (dirty pages) и overcommit.
  #
  # vm.dirty_ratio - процент памяти, при котором процессы начинают синхронную запись
  #   на диск. Когда этот процент достигнут, процессы блокируются до записи.
  #   Рекомендуется: 10-20 для серверов
  #
  # vm.dirty_background_ratio - процент памяти, при котором фоновые процессы начинают
  #   асинхронную запись на диск. Должно быть меньше dirty_ratio.
  #   Рекомендуется: 5-10 для серверов
  #
  # vm.overcommit_memory - политика overcommit памяти:
  #   - 0: эвристический алгоритм (по умолчанию)
  #   - 1: всегда разрешать overcommit (рекомендуется для виртуализации)
  #   - 2: не разрешать overcommit (может помешать запуску VM)
  #
  # Риски:
  # - Слишком высокие dirty_ratio/dirty_background_ratio могут привести к потере данных
  #   при сбое питания и долгой задержке при записи
  # - Слишком низкие значения могут снизить производительность из-за частых записей
  # - overcommit_memory=1 может привести к нехватке памяти при реальном использовании
  #
  # Применяется: Сразу, не требует перезагрузки
  # Файлы: /proc/sys/vm/dirty_ratio, /proc/sys/vm/dirty_background_ratio, /proc/sys/vm/overcommit_memory
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true  # Сохраняет в /etc/sysctl.conf для постоянства
    reload: true      # Применяет сразу
  loop:
    - { name: 'vm.dirty_ratio', value: "{{ host_dirty_ratio }}" }
    - { name: 'vm.dirty_background_ratio', value: "{{ host_dirty_background_ratio }}" }
    - { name: 'vm.overcommit_memory', value: "{{ host_overcommit_memory }}" }
  when: host_optimization_enabled
  tags:
    - optimization
    - memory

- name: Настройка hugepages
  # Настраивает количество hugepages - больших страниц памяти (обычно 2MB каждая)
  # вместо стандартных страниц 4KB. Улучшает производительность для виртуализации.
  #
  # Преимущества:
  # - Меньше TLB (Translation Lookaside Buffer) промахов
  # - Лучшая производительность для больших приложений и VM
  # - Меньше накладных расходов на управление памятью
  #
  # Недостатки:
  # - Hugepages резервируют память, она недоступна для обычных процессов
  # - Слишком большое количество может привести к нехватке обычной памяти
  #
  # Расчет: host_hugepages_count * 2MB = зарезервированная память
  # Пример: 1024 hugepages = 2GB зарезервированной памяти
  #
  # Риски:
  # - Слишком большое количество может привести к нехватке обычной памяти
  # - Может помешать запуску приложений, требующих много памяти
  #
  # Применяется: Сразу, но полный эффект после перезагрузки
  # Файл: /proc/sys/vm/nr_hugepages
  sysctl:
    name: vm.nr_hugepages
    value: "{{ host_hugepages_count }}"
    state: present
    sysctl_set: true  # Сохраняет в /etc/sysctl.conf для постоянства
    reload: true      # Применяет сразу
  when:
    - host_optimization_enabled
    - host_hugepages_enabled
  tags:
    - optimization
    - memory
    - hugepages

- name: Отключение swap
  # ⚠️ КРИТИЧЕСКАЯ ОПЕРАЦИЯ: Отключает все swap разделы и файлы.
  #
  # Что делает:
  # - Выполняет swapoff -a для отключения всех swap устройств
  # - Требует подтверждения через host_optimization_confirm_dangerous: true
  #
  # Риски:
  # - ⚠️ КРИТИЧЕСКИЙ: Может привести к нехватке памяти при пиковых нагрузках
  # - ⚠️ Может вызвать завершение процессов OOM killer
  # - ⚠️ Может привести к нестабильности системы
  # - ⚠️ Может привести к потере данных
  #
  # Требования:
  # - Минимум 16GB RAM (проверяется в safety-checks.yml)
  # - Использование swap не более 10% (проверяется в safety-checks.yml)
  # - host_optimization_confirm_dangerous: true
  #
  # Рекомендации:
  # - Используйте только на серверах с достаточным RAM (32GB+)
  # - Мониторьте использование памяти после отключения
  # - Рассмотрите уменьшение swappiness вместо полного отключения
  #
  # Применяется: Сразу, но также нужно закомментировать в fstab (следующая задача)
  # Команда: swapoff -a
  shell: |
    swapoff -a
  when:
    - host_optimization_enabled
    - host_swap_disabled
    - host_optimization_confirm_dangerous | default(false) == true
    - not ansible_check_mode
  register: swapoff_result
  failed_when: false  # Не критично, если swap уже отключен
  check_mode: false    # Нельзя выполнить в check mode
  tags:
    - optimization
    - memory
    - swap

- name: Комментирование swap в fstab
  # ⚠️ КРИТИЧЕСКАЯ ОПЕРАЦИЯ: Комментирует все записи swap в /etc/fstab.
  #
  # Что делает:
  # - Находит все строки с "swap" в fstab
  # - Комментирует их, добавляя # в начало строки
  # - Предотвращает автоматическое включение swap при загрузке
  #
  # Риски:
  # - ⚠️ КРИТИЧЕСКИЙ: Изменение fstab может привести к проблемам загрузки
  # - ⚠️ Неправильное изменение может сделать систему неработоспособной
  # - ⚠️ Требует перезагрузки для полного применения
  #
  # Требования:
  # - host_optimization_confirm_dangerous: true
  # - Резервная копия создается автоматически в backup.yml
  #
  # Восстановление:
  # - Раскомментируйте строки вручную или восстановите из бэкапа
  #
  # Применяется: Сразу, но полный эффект после перезагрузки
  # Файл: /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*\sswap\s)'  # Находит строки с swap, которые не закомментированы
    replace: '#\1'                 # Комментирует их
  when:
    - host_optimization_enabled
    - host_swap_disabled
    - host_optimization_confirm_dangerous | default(false) == true
  check_mode: false  # Нельзя выполнить в check mode
  tags:
    - optimization
    - memory
    - swap
