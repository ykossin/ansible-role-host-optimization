---
# ============================================================================
# Валидация переменных для host-optimization
# ============================================================================
# Этот файл проверяет все переменные роли на корректность перед применением
# изменений. Некорректные значения могут привести к нестабильности системы.
#
# Риски некорректных значений:
# - Некорректные параметры памяти могут вызвать проблемы с производительностью
# - Неправильный CPU governor может привести к проблемам с энергопотреблением
# - Неправильный I/O scheduler может снизить производительность дисков
# ============================================================================

- name: Валидация переменных host-optimization
  # Проверяет все переменные роли на корректность значений
  # Использует assert для проверки диапазонов и допустимых значений
  assert:
    that:
      # Проверка swappiness: должно быть в диапазоне 0-100
      # 0 = система избегает swap, 100 = система активно использует swap
      # Рекомендуется 1-10 для серверов с большим RAM
      - host_swappiness | int >= 0
      - host_swappiness | int <= 100
      
      # Проверка dirty_ratio: процент памяти для синхронной записи на диск
      # Должно быть в диапазоне 0-100
      # Рекомендуется 10-20 для серверов
      - host_dirty_ratio | int >= 0
      - host_dirty_ratio | int <= 100
      
      # Проверка dirty_background_ratio: процент памяти для асинхронной записи
      # Должно быть в диапазоне 0-100
      # Должно быть меньше dirty_ratio (проверяется отдельно)
      # Рекомендуется 5-10 для серверов
      - host_dirty_background_ratio | int >= 0
      - host_dirty_background_ratio | int <= 100
      
      # Проверка overcommit_memory: политика overcommit памяти
      # 0 = эвристический алгоритм (по умолчанию)
      # 1 = всегда разрешать overcommit (рекомендуется для виртуализации)
      # 2 = не разрешать overcommit
      - host_overcommit_memory in [0, 1, 2]
      
      # Проверка CPU governor: алгоритм управления частотой CPU
      # performance = максимальная производительность (постоянная высокая частота)
      # powersave = экономия энергии (низкая частота)
      # ondemand = по требованию (динамическое изменение частоты)
      # conservative = консервативный (медленное изменение частоты)
      # schedutil = планировщик ядра (современный алгоритм)
      - host_cpu_governor in ['performance', 'powersave', 'ondemand', 'conservative', 'schedutil']
      
      # Проверка I/O scheduler: алгоритм планирования операций ввода/вывода
      # none = для NVMe дисков (рекомендуется)
      # deadline = для SSD дисков
      # noop = для SSD дисков
      # cfq = для HDD дисков
      # bfq = для HDD дисков (лучшая производительность)
      # mq-deadline = для современных дисков
      # kyber = для современных дисков
      - host_io_scheduler in ['none', 'deadline', 'noop', 'cfq', 'bfq', 'mq-deadline', 'kyber']
      
      # Проверка лимита файловых дескрипторов: должно быть больше 0
      # Рекомендуется 65536 для серверов виртуализации
      - host_ulimit_nofile | int > 0
      
      # Проверка лимита процессов: должно быть больше 0
      # Рекомендуется 65536 для серверов виртуализации
      - host_ulimit_nproc | int > 0
      
      # Проверка количества hugepages: должно быть больше или равно 0
      # Каждая hugepage обычно 2MB, рекомендуется 1024+ для виртуализации
      - host_hugepages_count | int >= 0
    fail_msg: |
      ⚠️  Некорректное значение переменной host-optimization:
      
      - host_swappiness: {{ host_swappiness | default('не задано') }}
        (должно быть: 0-100)
        Описание: Определяет, насколько агрессивно система будет использовать swap.
        Рекомендуется: 1-10 для серверов с большим RAM
      
      - host_dirty_ratio: {{ host_dirty_ratio | default('не задано') }}
        (должно быть: 0-100)
        Описание: Процент памяти, при котором процессы начинают синхронную запись на диск.
        Рекомендуется: 10-20 для серверов
      
      - host_dirty_background_ratio: {{ host_dirty_background_ratio | default('не задано') }}
        (должно быть: 0-100)
        Описание: Процент памяти, при котором фоновые процессы начинают асинхронную запись.
        Рекомендуется: 5-10 для серверов
        ВАЖНО: Должно быть меньше host_dirty_ratio!
      
      - host_overcommit_memory: {{ host_overcommit_memory | default('не задано') }}
        (должно быть: 0, 1 или 2)
        Описание: Политика overcommit памяти.
        0 = эвристический алгоритм, 1 = всегда разрешать (для виртуализации), 2 = не разрешать
      
      - host_cpu_governor: {{ host_cpu_governor | default('не задано') }}
        (должно быть: performance, powersave, ondemand, conservative, schedutil)
        Описание: Алгоритм управления частотой CPU.
        Рекомендуется: performance для хостов виртуализации
      
      - host_io_scheduler: {{ host_io_scheduler | default('не задано') }}
        (должно быть: none, deadline, noop, cfq, bfq, mq-deadline, kyber)
        Описание: Алгоритм планирования операций ввода/вывода.
        Рекомендуется: none для NVMe, deadline/noop для SSD, cfq/bfq для HDD
      
      - host_ulimit_nofile: {{ host_ulimit_nofile | default('не задано') }}
        (должно быть: > 0)
        Описание: Лимит файловых дескрипторов.
        Рекомендуется: 65536 для серверов виртуализации
      
      - host_ulimit_nproc: {{ host_ulimit_nproc | default('не задано') }}
        (должно быть: > 0)
        Описание: Лимит процессов.
        Рекомендуется: 65536 для серверов виртуализации
      
      - host_hugepages_count: {{ host_hugepages_count | default('не задано') }}
        (должно быть: >= 0)
        Описание: Количество hugepages (обычно 2MB каждая).
        Рекомендуется: 1024+ для виртуализации
      
      Некорректные значения могут привести к нестабильности системы!
      Проверьте значения переменных в defaults/main.yml или в вашем playbook.
    success_msg: "✅ Все переменные host-optimization валидны"
  when: host_optimization_enabled
  tags:
    - optimization
    - validation
