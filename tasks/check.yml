---
# ============================================================================
# Проверка системы перед оптимизацией
# ============================================================================
# Этот файл собирает информацию о системе перед применением оптимизаций.
# Все задачи только читают информацию, не изменяют систему.
#
# Безопасность: ✅ Безопасные операции - только чтение информации
# Риски: Нет - задачи не изменяют систему
# ============================================================================

- name: Проверка архитектуры процессора
  # Определяет архитектуру процессора (x86_64, aarch64, etc.)
  # Используется для проверки совместимости оптимизаций
  # Команда: uname -m возвращает архитектуру машины
  command: uname -m
  register: host_arch
  changed_when: false  # Только чтение, не изменяет систему
  tags:
    - optimization
    - check

- name: Определение типа процессора (Intel/AMD)
  # Определяет производителя процессора через проверку флагов виртуализации
  # vmx = Intel VT-x (виртуализация Intel)
  # svm = AMD-V (виртуализация AMD)
  # Используется для автоматической настройки IOMMU параметров
  shell: |
    if grep -q "vmx" /proc/cpuinfo 2>/dev/null; then
      echo "intel"
    elif grep -q "svm" /proc/cpuinfo 2>/dev/null; then
      echo "amd"
    else
      echo "unknown"
    fi
  register: cpu_vendor
  changed_when: false  # Только чтение, не изменяет систему
  failed_when: false   # Не критично, если не удалось определить
  tags:
    - optimization
    - check

- name: Проверка поддержки виртуализации
  # Проверяет наличие флагов виртуализации в /proc/cpuinfo
  # vmx = Intel VT-x
  # svm = AMD-V
  # Если флаги отсутствуют, виртуализация не поддерживается
  shell: grep -E "(vmx|svm)" /proc/cpuinfo | head -1
  register: cpu_virtualization_flag
  changed_when: false  # Только чтение, не изменяет систему
  failed_when: false   # Не критично, если виртуализация не поддерживается
  tags:
    - optimization
    - check

- name: Получение информации о дисках
  # Получает список дисков и их текущий I/O scheduler
  # Используется для проверки перед настройкой I/O scheduler
  # Формат вывода: NAME TYPE SCHED (например: sda disk mq-deadline)
  shell: lsblk -d -n -o NAME,TYPE,SCHED | grep -v "loop"
  register: disk_info
  changed_when: false  # Только чтение, не изменяет систему
  failed_when: false   # Не критично, если команда не выполнилась
  tags:
    - optimization
    - check

- name: Отображение информации о системе
  # Выводит собранную информацию о системе
  # Помогает понять текущее состояние перед применением оптимизаций
  debug:
    msg:
      - "=== Информация о системе ==="
      - "Архитектура: {{ host_arch.stdout }}"
      - "Производитель CPU: {{ cpu_vendor.stdout }}"
      - "Виртуализация: {{ 'поддерживается' if cpu_virtualization_flag.rc == 0 else 'не поддерживается' }}"
      - "Диски: {{ disk_info.stdout_lines | default([]) }}"
      - ""
      - "Эта информация используется для автоматической настройки оптимизаций."
  when: host_optimization_enabled
  tags:
    - optimization
    - check
