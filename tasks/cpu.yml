---
# ============================================================================
# Оптимизация CPU
# ============================================================================
# Этот файл настраивает параметры CPU для максимальной производительности.
# Включает настройку CPU governor и frequency scaling.
#
# Безопасность:
# - ✅ Относительно безопасные операции
# - ⚠️ Режим performance увеличивает энергопотребление
#
# Риски:
# - Режим performance может привести к перегреву процессора
# - Увеличение энергопотребления может сократить срок службы оборудования
# ============================================================================

- name: Проверка доступности CPU scaling
  # Проверяет, доступно ли управление частотой CPU на этой системе.
  # Некоторые системы (особенно виртуальные машины) могут не поддерживать
  # изменение частоты CPU.
  #
  # Что проверяет:
  # - Существование файла /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
  # - Если файл существует, CPU scaling доступен
  #
  # Безопасность:
  # - ✅ Безопасная операция - только проверка
  # - ✅ Не изменяет систему
  stat:
    path: /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
  register: cpu_scaling_available
  tags:
    - optimization
    - cpu

- name: Настройка CPU governor для производительности
  # Устанавливает CPU governor для всех ядер процессора.
  #
  # Что делает:
  # - Проходит по всем ядрам CPU (cpu0, cpu1, cpu2, ...)
  # - Устанавливает указанный governor для каждого ядра
  # - Применяет изменения сразу
  #
  # CPU Governor - алгоритм управления частотой CPU:
  # - performance: максимальная производительность (постоянная высокая частота)
  #   Используется для максимальной производительности, но увеличивает энергопотребление
  # - powersave: экономия энергии (низкая частота)
  #   Используется для экономии энергии, но снижает производительность
  # - ondemand: по требованию (динамическое изменение частоты)
  #   Баланс между производительностью и энергопотреблением
  # - conservative: консервативный (медленное изменение частоты)
  #   Более плавное изменение частоты, чем ondemand
  # - schedutil: планировщик ядра (современный алгоритм)
  #   Интегрирован с планировщиком задач ядра
  #
  # Риски:
  # - ⚠️ Режим performance может привести к:
  #   - Увеличению энергопотребления
  #   - Перегреву процессора
  #   - Сокращению срока службы оборудования
  # - ⚠️ Режим powersave может привести к:
  #   - Снижению производительности
  #   - Задержкам при высокой нагрузке
  #
  # Применяется: Сразу, не требует перезагрузки
  # Файлы: /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
  shell: |
    if [ -f /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor ]; then
      for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
        if [ -f "$cpu" ]; then
          echo {{ host_cpu_governor }} > "$cpu" 2>/dev/null || true
        fi
      done
    fi
  when:
    - host_optimization_enabled
    - host_cpu_scaling_enabled
    - cpu_scaling_available.stat.exists
  register: cpu_governor_set
  changed_when: cpu_governor_set.rc == 0  # Считается измененным, если команда успешна
  failed_when: false  # Не критично, если не удалось установить
  tags:
    - optimization
    - cpu

- name: Установка CPU governor по умолчанию
  # Настраивает CPU governor по умолчанию в /etc/default/cpufrequtils.
  # Это значение будет использоваться при загрузке системы.
  #
  # Что делает:
  # - Создает или обновляет файл /etc/default/cpufrequtils
  # - Устанавливает GOVERNOR=<значение>
  # - Применяется при загрузке системы через systemd или init скрипты
  #
  # Безопасность:
  # - ✅ Безопасная операция
  # - ✅ Применяется при загрузке системы
  #
  # Применяется: Сразу, но полный эффект после перезагрузки
  # Файл: /etc/default/cpufrequtils
  lineinfile:
    path: /etc/default/cpufrequtils
    regexp: '^GOVERNOR='  # Находит существующую строку GOVERNOR=
    line: "GOVERNOR={{ host_cpu_governor }}"  # Устанавливает новое значение
    create: true  # Создает файл, если не существует
    mode: '0644'  # Права доступа: rw-r--r--
  when:
    - host_optimization_enabled
    - host_cpu_scaling_enabled
  tags:
    - optimization
    - cpu
