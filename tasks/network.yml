---
# ============================================================================
# Оптимизация сетевых параметров
# ============================================================================
# Этот файл настраивает сетевые параметры для виртуализации и производительности.
# Включает IP forwarding, TCP оптимизацию и параметры безопасности.
#
# Безопасность:
# - IP forwarding может изменить поведение файрвола
# - Требует дополнительной настройки безопасности
#
# Риски:
# - Включение IP forwarding может позволить маршрутизацию пакетов
# - Слишком большие TCP буферы могут увеличить использование памяти
# ============================================================================

- name: Включение IP forwarding для виртуализации (IPv4)
  # Включает IP forwarding для IPv4 - необходимо для маршрутизации пакетов
  # между виртуальными машинами и сетями.
  #
  # Что делает:
  # - Устанавливает net.ipv4.ip_forward = 1
  # - Позволяет системе маршрутизировать пакеты между интерфейсами
  # - Необходимо для работы NAT и мостов в виртуализации
  #
  # Риски:
  # - ⚠️ Может изменить поведение файрвола
  # - ⚠️ Позволяет маршрутизацию пакетов (требует настройки безопасности)
  # - ⚠️ Может потребоваться дополнительная настройка iptables/ufw
  #
  # Применяется: Сразу, не требует перезагрузки
  # Файл: /proc/sys/net/ipv4/ip_forward
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    sysctl_set: true  # Сохраняет в /etc/sysctl.conf для постоянства
    reload: true      # Применяет сразу
  when:
    - host_optimization_enabled
    - host_ip_forward_enabled
    - host_ip_forward_ipv4
  tags:
    - optimization
    - network

- name: Включение IP forwarding IPv6
  # Включает IP forwarding для IPv6 - необходимо для маршрутизации IPv6 пакетов
  # между виртуальными машинами и сетями.
  #
  # Что делает:
  # - Устанавливает net.ipv6.conf.all.forwarding = 1
  # - Позволяет системе маршрутизировать IPv6 пакеты между интерфейсами
  # - Необходимо для работы IPv6 в виртуализации
  #
  # Риски:
  # - ⚠️ Может изменить поведение файрвола для IPv6
  # - ⚠️ Позволяет маршрутизацию IPv6 пакетов
  #
  # Применяется: Сразу, не требует перезагрузки
  # Файл: /proc/sys/net/ipv6/conf/all/forwarding
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
    sysctl_set: true  # Сохраняет в /etc/sysctl.conf для постоянства
    reload: true      # Применяет сразу
  when:
    - host_optimization_enabled
    - host_ip_forward_enabled
    - host_ip_forward_ipv6
  tags:
    - optimization
    - network

- name: Настройка параметров производительности сети
  # Настраивает TCP буферы и параметры для лучшей производительности сети.
  #
  # Параметры (из host_network_optimization):
  # - net.core.rmem_max: максимальный размер буфера приема (по умолчанию: 134217728 = 128MB)
  # - net.core.wmem_max: максимальный размер буфера передачи (по умолчанию: 134217728 = 128MB)
  # - net.ipv4.tcp_rmem: размеры буферов приема TCP (min default max)
  #   По умолчанию: "4096 87380 134217728" (4KB, 85KB, 128MB)
  # - net.ipv4.tcp_wmem: размеры буферов передачи TCP (min default max)
  #   По умолчанию: "4096 65536 134217728" (4KB, 64KB, 128MB)
  # - net.core.netdev_max_backlog: максимальная очередь сетевых устройств (по умолчанию: 5000)
  # - net.ipv4.tcp_fin_timeout: таймаут закрытия TCP соединений (по умолчанию: 30 секунд)
  # - net.ipv4.tcp_keepalive_time: интервал keepalive для TCP (по умолчанию: 300 секунд)
  #
  # Риски:
  # - ⚠️ Слишком большие буферы могут увеличить использование памяти
  # - ⚠️ Может привести к проблемам с производительностью при нехватке памяти
  # - ⚠️ Слишком маленькие буферы могут снизить пропускную способность сети
  #
  # Рекомендации:
  # - Используйте значения по умолчанию для большинства случаев
  # - Увеличивайте буферы только при необходимости высокой пропускной способности
  #
  # Применяется: Сразу, не требует перезагрузки
  # Файлы: /proc/sys/net/core/rmem_max, /proc/sys/net/core/wmem_max, и т.д.
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true  # Сохраняет в /etc/sysctl.conf для постоянства
    reload: true      # Применяет сразу
  loop: "{{ host_network_optimization | dict2items }}"
  when: host_optimization_enabled
  tags:
    - optimization
    - network

- name: Настройка параметров безопасности sysctl
  # Настраивает параметры безопасности сети для защиты от атак.
  #
  # Параметры (из host_security_sysctl):
  # - net.ipv4.conf.all.send_redirects: 0 - отключить отправку ICMP редиректов
  #   Защита от атак с использованием редиректов
  # - net.ipv4.conf.default.send_redirects: 0 - отключить отправку редиректов по умолчанию
  # - net.ipv4.conf.all.accept_redirects: 0 - отключить прием ICMP редиректов
  #   Защита от атак с использованием редиректов
  # - net.ipv4.conf.default.accept_redirects: 0 - отключить прием редиректов по умолчанию
  #
  # Безопасность:
  # - ✅ Улучшает безопасность системы
  # - ✅ Защищает от атак с использованием редиректов
  # - ✅ Не влияет на функциональность
  #
  # Риски:
  # - ✅ Безопасная операция - только улучшает безопасность
  # - ✅ Не влияет на функциональность системы
  #
  # Применяется: Сразу, не требует перезагрузки
  # Файлы: /proc/sys/net/ipv4/conf/all/send_redirects, и т.д.
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true  # Сохраняет в /etc/sysctl.conf для постоянства
    reload: true      # Применяет сразу
  loop: "{{ host_security_sysctl | dict2items }}"
  when:
    - host_optimization_enabled
    # Исключаем net.ipv4.ip_forward, если он уже настроен отдельно
    - item.key != "net.ipv4.ip_forward" or not host_ip_forward_enabled
  tags:
    - optimization
    - network
    - security
